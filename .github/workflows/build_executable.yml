name: Build and Deploy executable
# Deploy sphinx documentation to GitHub Pages in docs branch

on: push

concurrency:
    group: build
    cancel-in-progress: true

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            # Checkout this repository
            - name: Checkout repository
              uses: actions/checkout@v4
            # Checkout storm dependency (to switch to the official one once support for sin/cos is integrated)
            - name: Checkout STORM
              uses: actions/checkout@v4
              with:
                repository: boschresearch/storm
                ref: support-for-sin-cos-constants
                path: external_dependencies/storm
            # Enable ccache
            - name: ccache
              uses: hendrikmuhs/ccache-action@v1.2
              # install the dependencies
            - name: Install dependencies
              run: |
                    sudo apt install build-essential git cmake libboost-all-dev libcln-dev libgmp-dev libginac-dev automake libglpk-dev libhwloc-dev libz3-dev libxerces-c-dev libeigen3-dev libgtest-dev
            - name: Build Storm
              run: |
                    export PATH="/usr/lib/ccache:/usr/local/opt/ccache/libexec:$PATH"
                    mkdir external_dependencies/storm/build
                    cd external_dependencies/storm/build
                    cmake -DSTORM_USE_SPOT_SHIPPED=ON ..
                    make
            - name: Build smc_storm
              run: |
                    mkdir build
                    cd build
                    cmake .. -DCMAKE_BUILD_TYPE=Release
                    make
            - name: Run tests
              run: |
                    cd build
                    ctest
            - name: Install chrpath
              run: sudo apt install chrpath
            - name: Copy lib and executables in deploy folder
              run: |
                    mkdir deployment
                    cd deployment
                    # Copy the dependencies
                    mkdir 3rd_party
                    cp ../external_dependencies/storm/build/lib/libstorm.so 3rd_party
                    cp ../external_dependencies/storm/build/lib/libstorm-parsers.so 3rd_party
                    cp ../external_dependencies/storm/build/resources/3rdparty/carl/libcarl.so.14.27 3rd_party
                    cp ../external_dependencies/storm/build/resources/3rdparty/spot/lib/libspot.so.0 3rd_party
                    cp ../external_dependencies/storm/build/resources/3rdparty/spot/lib/libbddx.so.0 3rd_party
                    # Copy the smc_storm lib
                    mkdir lib
                    cp ../build/lib/libsmc_storm_lib.so lib
                    mkdir bin
                    cp ../build/bin/smc_storm bin
            - name: Set new rpaths in deployment
              run: |
                    cd deployment/bin
                    chrpath -r ../3rd_party ../3rd_party/libstorm.so
                    chrpath -r ../3rd_party ../3rd_party/libstorm-parsers.so
                    chrpath -r ../3rd_party ../lib/libsmc_storm_lib.so
                    chrpath -r ../lib smc_storm
